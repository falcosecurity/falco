version: 2
jobs:
  # build using ubuntu LTS
  # This build is dynamic, most dependencies are taken from the OS
  "build/ubuntu-bionic":
    docker:
      - image: ubuntu:bionic
    steps:
      - checkout
      - run:
          name: update base image
          command: apt update -y
      - run:
          name: install dependencies
          command: apt install libssl-dev libyaml-dev libncurses-dev libc-ares-dev libprotobuf-dev protobuf-compiler libjq-dev libyaml-cpp-dev libgrpc++-dev protobuf-compiler-grpc rpm linux-headers-$(uname -r) libelf-dev cmake build-essential libcurl4-openssl-dev -y
      - run:
          name: prepare project
          command: |
            mkdir build
            pushd build
            cmake ..
            popd
      - run:
          name: build
          command: |
            pushd build
            make -j4 all
            popd
      - run:
          name: run unit tests
          command: |
            pushd build
            make tests
            popd
  # build using our own builder base image using centos 7
  # This build is static, dependencies are bundled in the falco binary
  "build/centos7":
    docker:
      - image: falcosecurity/falco-builder:dynamic-builds # todo(fntlnz): replace this with the actual image once PR #968 is merged
        environment:
          BUILD_TYPE: "release"
    steps:
      - checkout:
          path: /source/falco
      - run:
          name: prepare project
          command: /usr/bin/entrypoint cmake
      - run:
          name: build
          command: /usr/bin/entrypoint all
      - run:
          name: run unit tests
          command: /usr/bin/entrypoint tests
      - run:
          name: build packages
          command: /usr/bin/entrypoint package
      - persist_to_workspace:
          root: /
          paths:
            - build
      - run:
          command: |
            mkdir -p /tmp/packages
            cp /build/release/*.deb /tmp/packages
            cp /build/release/*.tar.gz /tmp/packages
            cp /build/release/*.rpm /tmp/packages
      - store_artifacts:
          path: /tmp/packages
  # execute integration tests based on the build results coming from the "build/centos7" job
  "tests/integration":
    docker:
      - image: falcosecurity/falco-tester:dynamic-builds # todo(fntlnz): replace this with the actual image once PR #968 is merged
        environment:
          SOURCE_DIR: "/source"
          BUILD_DIR: "/build"
          BUILD_TYPE: "release"
    steps:
      - setup_remote_docker
      - checkout:
          path: /source/falco
      - attach_workspace:
          at: /
      - run:
          name: execute integration tests
          command: /usr/bin/entrypoint test
workflows:
  version: 2
  build_and_test:
    jobs:
      - "build/ubuntu-bionic"
      - "build/centos7"
      - "tests/integration":
          requires:
            - "build/centos7"
